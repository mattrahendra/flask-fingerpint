<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Fingerprint System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            primary: '#0a0e27',
                            secondary: '#151b3d',
                            accent: '#1e2749'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-primary text-gray-100 min-h-screen">
    <header class="bg-dark-secondary border-b border-dark-accent">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-fingerprint text-3xl text-blue-500"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Fingerprint System</h1>
                        <p class="text-xs text-gray-400">Dashboard & Monitoring - Dual-Scan Verification</p>
                    </div>
                </div>
                <a href="/" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Enrollment</span>
                </a>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-6 py-8">
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-dark-secondary rounded-xl p-6 border border-dark-accent">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Total Users</p>
                        <p class="text-3xl font-bold" id="totalUsers">0</p>
                    </div>
                    <div class="bg-blue-500/20 p-4 rounded-lg">
                        <i class="fas fa-users text-2xl text-blue-500"></i>
                    </div>
                </div>
            </div>

            <div class="bg-dark-secondary rounded-xl p-6 border border-dark-accent">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Enrolled</p>
                        <p class="text-3xl font-bold text-green-500" id="enrolledUsers">0</p>
                    </div>
                    <div class="bg-green-500/20 p-4 rounded-lg">
                        <i class="fas fa-check-circle text-2xl text-green-500"></i>
                    </div>
                </div>
            </div>

            <div class="bg-dark-secondary rounded-xl p-6 border border-dark-accent">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Today Success</p>
                        <p class="text-3xl font-bold text-green-400" id="todaySuccess">0</p>
                    </div>
                    <div class="bg-green-400/20 p-4 rounded-lg">
                        <i class="fas fa-door-open text-2xl text-green-400"></i>
                    </div>
                </div>
            </div>

            <div class="bg-dark-secondary rounded-xl p-6 border border-dark-accent">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-sm mb-1">Today Failed</p>
                        <p class="text-3xl font-bold text-red-400" id="todayFailed">0</p>
                    </div>
                    <div class="bg-red-400/20 p-4 rounded-lg">
                        <i class="fas fa-door-closed text-2xl text-red-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Banner -->
        <div class="bg-gradient-to-r from-purple-500/20 to-blue-500/20 border border-purple-500/30 rounded-xl p-4 mb-8">
            <div class="flex items-center space-x-3">
                <i class="fas fa-shield-check text-2xl text-purple-400"></i>
                <div>
                    <p class="font-semibold text-purple-300">Enhanced Security</p>
                    <p class="text-sm text-gray-400">All enrollments use dual-scan verification for maximum accuracy</p>
                </div>
            </div>
        </div>

        <!-- Refresh Button -->
        <div class="flex gap-4 mb-8">
            <button onclick="loadData()" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg transition">
                <i class="fas fa-sync-alt"></i>
                <span>Refresh Data</span>
            </button>
        </div>

        <!-- Access Logs Table -->
        <div class="bg-dark-secondary rounded-xl border border-dark-accent mb-8">
            <div class="p-6 border-b border-dark-accent">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i class="fas fa-history text-purple-500"></i>
                        <span>Access Logs (Latest 100)</span>
                    </h2>
                    <div class="flex space-x-4 text-sm">
                        <span class="text-gray-400">
                            <i class="fas fa-check-circle text-green-400 mr-1"></i>
                            Success: <span id="logSuccessCount" class="font-bold">0</span>
                        </span>
                        <span class="text-gray-400">
                            <i class="fas fa-times-circle text-red-400 mr-1"></i>
                            Failed: <span id="logFailedCount" class="font-bold">0</span>
                        </span>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-dark-accent">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Timestamp (WIB)</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">User ID</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Name</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Status</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Confidence</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Sensor</th>
                        </tr>
                    </thead>
                    <tbody id="logsBody" class="divide-y divide-dark-accent">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Users Table -->
        <div class="bg-dark-secondary rounded-xl border border-dark-accent">
            <div class="p-6 border-b border-dark-accent">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <i class="fas fa-users text-blue-500"></i>
                        <span>Registered Users</span>
                    </h2>
                    <span class="text-sm text-gray-400" id="usersCount">0 users</span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-dark-accent">
                        <tr>
                            <th class="px-6 py-4 text-left text-sm font-semibold">User ID</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Name</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Status</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Registered (WIB)</th>
                            <th class="px-6 py-4 text-left text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersBody" class="divide-y divide-dark-accent">
                        <tr>
                            <td colspan="5" class="px-6 py-8 text-center text-gray-400">
                                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-dark-secondary border border-dark-accent rounded-lg shadow-xl p-4 transform translate-y-32 transition-transform duration-300 max-w-sm z-50">
        <div class="flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-info-circle text-2xl"></i>
            <p id="toastMessage" class="text-sm"></p>
        </div>
    </div>

    <script>
        loadData();
        setInterval(loadData, 5000); // Auto refresh every 5 seconds

        async function loadData() {
            try {
                // Load stats
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();
                
                if (statsData.status === 'success') {
                    document.getElementById('totalUsers').textContent = statsData.stats.total_users;
                    document.getElementById('enrolledUsers').textContent = statsData.stats.enrolled;
                    document.getElementById('todaySuccess').textContent = statsData.stats.today_success;
                    document.getElementById('todayFailed').textContent = statsData.stats.today_failed;
                }

                // Load users
                const usersResponse = await fetch('/api/users');
                const usersData = await usersResponse.json();
                
                if (usersData.status === 'success') {
                    displayUsers(usersData.users);
                }

                // Load access logs
                const logsResponse = await fetch('/api/access_logs');
                const logsData = await logsResponse.json();
                
                if (logsData.status === 'success') {
                    displayLogs(logsData.logs);
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersBody');
            document.getElementById('usersCount').textContent = `${users.length} users`;

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-400">
                            <i class="fas fa-user-slash text-3xl mb-2"></i>
                            <p>No users registered yet</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-dark-accent/50 transition">
                    <td class="px-6 py-4">
                        <span class="font-mono font-semibold text-blue-400">${user.user_id}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user-circle text-gray-400"></i>
                            <span class="font-medium">${user.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        ${getStatusBadge(user.status)}
                    </td>
                    <td class="px-6 py-4 text-gray-400 text-sm">
                        ${formatDate(user.registered_at)}
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="deleteUser('${user.user_id}', '${user.name}')" 
                                class="text-red-400 hover:text-red-300 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'enrolled': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-500/20 text-green-400"><i class="fas fa-shield-check mr-1"></i> Enrolled</span>',
                'pending': '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-500/20 text-yellow-400"><i class="fas fa-clock mr-1"></i> Pending</span>'
            };
            return badges[status] || '<span class="text-gray-400">' + status + '</span>';
        }

        function displayLogs(logs) {
            const tbody = document.getElementById('logsBody');
            
            const successCount = logs.filter(l => l.success).length;
            const failedCount = logs.filter(l => !l.success).length;
            
            document.getElementById('logSuccessCount').textContent = successCount;
            document.getElementById('logFailedCount').textContent = failedCount;

            if (logs.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-400">
                            <i class="fas fa-clipboard text-3xl mb-2"></i>
                            <p>No access logs yet</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr class="hover:bg-dark-accent/50 transition ${!log.success ? 'bg-red-500/5' : ''}">
                    <td class="px-6 py-4 text-sm text-gray-400">
                        ${formatDate(log.timestamp)}
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-mono font-semibold ${log.success ? 'text-blue-400' : 'text-gray-500'}">${log.user_id}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center space-x-2">
                            <i class="fas fa-user-circle ${log.success ? 'text-gray-400' : 'text-red-400'}"></i>
                            <span class="font-medium ${!log.success ? 'text-gray-500' : ''}">${log.name}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        ${log.success 
                            ? '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-500/20 text-green-400"><i class="fas fa-check-circle mr-1"></i> Success</span>'
                            : '<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-500/20 text-red-400"><i class="fas fa-times-circle mr-1"></i> Failed</span>'
                        }
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-semibold ${getConfidenceColor(log.confidence)}">${log.confidence}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-gray-400">Sensor ${log.sensor_id}</span>
                    </td>
                </tr>
            `).join('');
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 200) return 'text-green-400';
            if (confidence >= 150) return 'text-yellow-400';
            if (confidence >= 100) return 'text-orange-400';
            return 'text-red-400';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            });
        }

        async function deleteUser(userId, userName) {
            if (!confirm(`Delete user "${userName}" (${userId})?\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/delete_user/${userId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showToast(`User ${userName} deleted successfully`, 'success');
                    loadData();
                } else {
                    showToast('Failed to delete user: ' + data.message, 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            const configs = {
                success: { icon: 'fa-check-circle', color: 'text-green-500' },
                error: { icon: 'fa-exclamation-circle', color: 'text-red-500' },
                info: { icon: 'fa-info-circle', color: 'text-blue-500' }
            };
            
            const config = configs[type] || configs.info;
            icon.className = `fas ${config.icon} text-2xl ${config.color}`;
            messageEl.textContent = message;
            
            toast.style.transform = 'translateY(0)';
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
            }, 3000);
        }
    </script>
</body>
</html>