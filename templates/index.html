<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingerprint Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            primary: '#0a0e27',
                            secondary: '#151b3d',
                            accent: '#1e2749'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-primary text-gray-100 min-h-screen">
    <nav class="bg-dark-secondary border-b border-dark-accent">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-fingerprint text-3xl text-blue-500"></i>
                    <div>
                        <h1 class="text-xl font-bold">Fingerprint System</h1>
                        <p class="text-xs text-gray-400">Enhanced Dual-Scan Enrollment</p>
                    </div>
                </div>
                <a href="/dashboard" class="flex items-center space-x-2 bg-dark-accent hover:bg-dark-accent/80 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-chart-bar"></i>
                    <span>Dashboard</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-12 max-w-2xl">
        <div class="bg-dark-secondary rounded-2xl shadow-2xl p-8 border border-dark-accent">
            <!-- Step 1: Name Input -->
            <div id="step1">
                <div class="text-center mb-8">
                    <div class="inline-block bg-blue-500/20 p-6 rounded-full mb-4">
                        <i class="fas fa-user-plus text-5xl text-blue-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2">Register New User</h2>
                    <p class="text-gray-400">Enter your name to begin enrollment</p>
                </div>

                <form id="nameForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            <i class="fas fa-user mr-2 text-blue-500"></i>Full Name
                        </label>
                        <input type="text" id="userName" 
                               class="w-full px-4 py-3 bg-dark-accent border border-dark-accent rounded-lg focus:border-blue-500 focus:outline-none text-gray-100"
                               placeholder="Enter your full name" required autofocus>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-arrow-right mr-2"></i>Start Enrollment
                    </button>
                </form>
                <div id="errorMessage" class="mt-4 hidden bg-red-500/20 border border-red-500 text-red-400 px-4 py-3 rounded-lg"></div>
            </div>

            <!-- Step 2: Enrollment Process -->
            <div id="step2" class="hidden">
                <div class="text-center mb-8">
                    <div id="fingerIcon" class="inline-block bg-blue-500/20 p-6 rounded-full mb-4">
                        <i class="fas fa-fingerprint text-5xl text-blue-500"></i>
                    </div>
                    <h2 id="stepTitle" class="text-3xl font-bold mb-2">Preparing...</h2>
                    <p id="stepInstruction" class="text-gray-400">Please wait...</p>
                    <p class="text-sm text-gray-500 mt-2">User ID: <span id="assignedUserId" class="text-blue-400 font-mono">---</span></p>
                </div>

                <!-- Progress Steps -->
                <div class="space-y-4 mb-8">
                    <!-- Step 1: First Scan -->
                    <div id="progressStep1" class="flex items-center gap-4 p-4 bg-dark-accent rounded-lg opacity-50">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center">
                            <i class="fas fa-hand-point-down text-white"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold">Step 1: Place Finger</p>
                            <p class="text-sm text-gray-400">Place your finger on the sensor</p>
                        </div>
                        <i id="checkStep1" class="fas fa-clock text-gray-500 text-xl"></i>
                    </div>

                    <!-- Step 2: Remove Finger -->
                    <div id="progressStep2" class="flex items-center gap-4 p-4 bg-dark-accent rounded-lg opacity-50">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center">
                            <i class="fas fa-hand-paper text-white"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold">Step 2: Lift Finger</p>
                            <p class="text-sm text-gray-400">Remove your finger from the sensor</p>
                        </div>
                        <i id="checkStep2" class="fas fa-clock text-gray-500 text-xl"></i>
                    </div>

                    <!-- Step 3: Second Scan -->
                    <div id="progressStep3" class="flex items-center gap-4 p-4 bg-dark-accent rounded-lg opacity-50">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center">
                            <i class="fas fa-hand-point-down text-white"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold">Step 3: Place Again</p>
                            <p class="text-sm text-gray-400">Place the SAME finger again</p>
                        </div>
                        <i id="checkStep3" class="fas fa-clock text-gray-500 text-xl"></i>
                    </div>
                </div>

                <!-- Status Message -->
                <div id="statusBox" class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 text-center mb-6">
                    <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                    <span id="statusMessage" class="text-sm text-blue-300">Waiting for sensor...</span>
                </div>

                <button onclick="cancelEnroll()" class="w-full bg-dark-accent hover:bg-dark-accent/80 py-3 rounded-lg transition">
                    <i class="fas fa-times mr-2"></i>Cancel Enrollment
                </button>
            </div>

            <!-- Step 3: Success -->
            <div id="step3" class="hidden text-center">
                <div class="mb-6">
                    <div class="inline-block bg-green-500/20 p-6 rounded-full mb-4 animate-bounce">
                        <i class="fas fa-check-circle text-6xl text-green-500"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-green-500 mb-2">Enrollment Complete!</h3>
                    <p class="text-gray-400">Your fingerprint has been verified and registered</p>
                </div>
                
                <div class="bg-dark-accent rounded-xl p-6 mb-6 space-y-3">
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">User ID:</span>
                        <span class="font-bold text-blue-400 font-mono" id="successUserId">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">Name:</span>
                        <span class="font-bold" id="successUserName">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-400">Verification:</span>
                        <span class="text-green-500 font-semibold">
                            <i class="fas fa-shield-check mr-1"></i>Dual-Scan Verified
                        </span>
                    </div>
                </div>

                <button onclick="registerAnother()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-plus mr-2"></i>Register Another User
                </button>
            </div>

            <!-- Step 4: Error -->
            <div id="step4" class="hidden text-center">
                <div class="mb-6">
                    <div class="inline-block bg-red-500/20 p-6 rounded-full mb-4">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-500"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-red-500 mb-2">Enrollment Failed</h3>
                    <p id="errorText" class="text-gray-400">An error occurred during enrollment</p>
                </div>

                <button onclick="registerAnother()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-redo mr-2"></i>Try Again
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-dark-secondary border border-dark-accent rounded-lg shadow-xl p-4 transform translate-y-32 transition-transform duration-300 max-w-sm z-50">
        <div class="flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-info-circle text-2xl"></i>
            <p id="toastMessage" class="text-sm"></p>
        </div>
    </div>

    <script>
        let currentUserId = '';
        let currentUserName = '';
        let checkInterval = null;
        let currentStep = 0;

        document.getElementById('nameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            currentUserName = document.getElementById('userName').value.trim();
            const errorMsg = document.getElementById('errorMessage');

            try {
                const response = await fetch('/api/start_enroll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: currentUserName })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUserId = data.user_id;
                    document.getElementById('assignedUserId').textContent = currentUserId;
                    goToStep(2);
                    startChecking();
                    showToast(`Enrollment started for ${currentUserName}`, 'info');
                    errorMsg.classList.add('hidden');
                } else {
                    errorMsg.textContent = data.message;
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Error: ' + error.message;
                errorMsg.classList.remove('hidden');
            }
        });

        function startChecking() {
            checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check_enroll_status/${currentUserId}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        updateEnrollmentUI(data.enrollment_status, data.message);
                        
                        if (data.completed) {
                            clearInterval(checkInterval);
                            setTimeout(() => showSuccess(), 500);
                        }
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 500);  // Check every 500ms for real-time updates
        }

        function updateEnrollmentUI(status, message) {
            const fingerIcon = document.getElementById('fingerIcon');
            const stepTitle = document.getElementById('stepTitle');
            const stepInstruction = document.getElementById('stepInstruction');
            const statusMessage = document.getElementById('statusMessage');
            const statusBox = document.getElementById('statusBox');

            statusMessage.textContent = message;

            switch(status) {
                case 'waiting_first_scan':
                    if (currentStep !== 1) {
                        currentStep = 1;
                        activateStep(1);
                        fingerIcon.innerHTML = '<i class="fas fa-fingerprint text-5xl text-blue-500 animate-pulse"></i>';
                        stepTitle.textContent = 'Place Your Finger';
                        stepInstruction.textContent = 'Place your finger on Sensor 1';
                        statusBox.className = 'bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 text-center mb-6';
                    }
                    break;

                case 'waiting_remove':
                    if (currentStep !== 2) {
                        currentStep = 2;
                        completeStep(1);
                        activateStep(2);
                        fingerIcon.innerHTML = '<i class="fas fa-hand-paper text-5xl text-yellow-500 animate-bounce"></i>';
                        stepTitle.textContent = 'Lift Your Finger';
                        stepInstruction.textContent = 'Remove your finger from the sensor';
                        statusBox.className = 'bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 text-center mb-6';
                        showToast('First scan complete! Lift your finger', 'success');
                    }
                    break;

                case 'waiting_second_scan':
                    if (currentStep !== 3) {
                        currentStep = 3;
                        completeStep(2);
                        activateStep(3);
                        fingerIcon.innerHTML = '<i class="fas fa-fingerprint text-5xl text-green-500 animate-pulse"></i>';
                        stepTitle.textContent = 'Place Finger Again';
                        stepInstruction.textContent = 'Place the SAME finger on the sensor';
                        statusBox.className = 'bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-center mb-6';
                        showToast('Now place the same finger again', 'info');
                    }
                    break;

                case 'mismatch':
                    showError('Fingerprints did not match! Please use the SAME finger for both scans.');
                    break;

                case 'error':
                    showError(message);
                    break;

                case 'timeout':
                    showError('Enrollment timeout. Please try again.');
                    break;
            }
        }

        function activateStep(stepNum) {
            const stepEl = document.getElementById(`progressStep${stepNum}`);
            stepEl.classList.remove('opacity-50');
            stepEl.classList.add('bg-blue-500/20', 'border', 'border-blue-500/50');
            const circle = stepEl.querySelector('.rounded-full');
            circle.classList.remove('bg-gray-600');
            circle.classList.add('bg-blue-600', 'animate-pulse');
        }

        function completeStep(stepNum) {
            const stepEl = document.getElementById(`progressStep${stepNum}`);
            stepEl.classList.remove('bg-blue-500/20', 'border-blue-500/50');
            stepEl.classList.add('bg-green-500/20', 'border', 'border-green-500/50');
            const circle = stepEl.querySelector('.rounded-full');
            circle.classList.remove('bg-blue-600', 'animate-pulse');
            circle.classList.add('bg-green-600');
            const check = document.getElementById(`checkStep${stepNum}`);
            check.className = 'fas fa-check-circle text-green-500 text-xl';
        }

        function goToStep(stepNumber) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById('step4').classList.add('hidden');
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
        }

        function showSuccess() {
            completeStep(3);
            goToStep(3);
            document.getElementById('successUserId').textContent = currentUserId;
            document.getElementById('successUserName').textContent = currentUserName;
            showToast('Enrollment completed successfully!', 'success');
        }

        function showError(message) {
            if (checkInterval) clearInterval(checkInterval);
            document.getElementById('errorText').textContent = message;
            goToStep(4);
            showToast(message, 'error');
            
            // User sudah dihapus dari server oleh ESP32, tidak perlu delete lagi
        }

        function cancelEnroll() {
            if (checkInterval) clearInterval(checkInterval);
            // User akan dihapus oleh ESP32 saat cancel
            showToast('Enrollment cancelled', 'info');
            registerAnother();
        }

        function registerAnother() {
            goToStep(1);
            document.getElementById('nameForm').reset();
            document.getElementById('errorMessage').classList.add('hidden');
            currentUserId = '';
            currentUserName = '';
            currentStep = 0;
            
            // Reset all progress steps
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`progressStep${i}`);
                stepEl.className = 'flex items-center gap-4 p-4 bg-dark-accent rounded-lg opacity-50';
                const circle = stepEl.querySelector('.rounded-full');
                circle.className = 'flex-shrink-0 w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center';
                const check = document.getElementById(`checkStep${i}`);
                check.className = 'fas fa-clock text-gray-500 text-xl';
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            const configs = {
                success: { icon: 'fa-check-circle', color: 'text-green-500' },
                error: { icon: 'fa-exclamation-circle', color: 'text-red-500' },
                info: { icon: 'fa-info-circle', color: 'text-blue-500' }
            };
            
            const config = configs[type] || configs.info;
            icon.className = `fas ${config.icon} text-2xl ${config.color}`;
            messageEl.textContent = message;
            
            toast.style.transform = 'translateY(0)';
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
            }, 3000);
        }

        window.addEventListener('beforeunload', () => {
            if (checkInterval) clearInterval(checkInterval);
        });
    </script>
</body>
</html>