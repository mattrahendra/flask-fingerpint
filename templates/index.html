<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingerprint Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            primary: '#0a0e27',
                            secondary: '#151b3d',
                            accent: '#1e2749'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-primary text-gray-100 min-h-screen">
    <nav class="bg-dark-secondary border-b border-dark-accent">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-fingerprint text-3xl text-blue-500"></i>
                    <div>
                        <h1 class="text-xl font-bold">Fingerprint System</h1>
                        <p class="text-xs text-gray-400">Enrollment Portal</p>
                    </div>
                </div>
                <a href="/dashboard" class="flex items-center space-x-2 bg-dark-accent hover:bg-dark-accent/80 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-chart-bar"></i>
                    <span>Dashboard</span>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-12 max-w-2xl">
        <div class="bg-dark-secondary rounded-2xl shadow-2xl p-8 border border-dark-accent">
            <!-- Step 1: Name Input -->
            <div id="step1">
                <div class="text-center mb-8">
                    <div class="inline-block bg-blue-500/20 p-6 rounded-full mb-4">
                        <i class="fas fa-user-plus text-5xl text-blue-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2">Register New User</h2>
                    <p class="text-gray-400">Enter your name to begin enrollment</p>
                </div>

                <form id="nameForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            <i class="fas fa-user mr-2 text-blue-500"></i>Full Name
                        </label>
                        <input type="text" id="userName" 
                               class="w-full px-4 py-3 bg-dark-accent border border-dark-accent rounded-lg focus:border-blue-500 focus:outline-none text-gray-100"
                               placeholder="Enter your full name" required autofocus>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-arrow-right mr-2"></i>Start Enrollment
                    </button>
                </form>
                <div id="errorMessage" class="mt-4 hidden bg-red-500/20 border border-red-500 text-red-400 px-4 py-3 rounded-lg"></div>
            </div>

            <!-- Step 2: Enrollment Progress -->
            <div id="step2" class="hidden">
                <div class="text-center mb-8">
                    <div class="inline-block bg-blue-500/20 p-6 rounded-full mb-4 animate-pulse">
                        <i class="fas fa-fingerprint text-5xl text-blue-500"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2">Scan Your Fingerprint</h2>
                    <p class="text-gray-400">Place your finger on Sensor 1 (Enrollment)</p>
                    <p class="text-sm text-gray-500 mt-2">User ID: <span id="assignedUserId" class="text-blue-400 font-mono">---</span></p>
                </div>

                <!-- Progress Bar -->
                <div class="mb-8">
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-400">Progress</span>
                        <span class="text-blue-400 font-semibold"><span id="currentCount">0</span> / 3 Templates</span>
                    </div>
                    <div class="w-full bg-dark-accent rounded-full h-3 overflow-hidden">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 transition-all duration-500 rounded-full" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Template Status -->
                <div class="space-y-3 mb-6">
                    <div id="template1" class="flex items-center justify-between bg-dark-accent p-4 rounded-lg opacity-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-fingerprint text-2xl text-gray-500"></i>
                            <span>Template 1</span>
                        </div>
                        <i class="fas fa-clock text-gray-500"></i>
                    </div>
                    <div id="template2" class="flex items-center justify-between bg-dark-accent p-4 rounded-lg opacity-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-fingerprint text-2xl text-gray-500"></i>
                            <span>Template 2</span>
                        </div>
                        <i class="fas fa-clock text-gray-500"></i>
                    </div>
                    <div id="template3" class="flex items-center justify-between bg-dark-accent p-4 rounded-lg opacity-50">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-fingerprint text-2xl text-gray-500"></i>
                            <span>Template 3</span>
                        </div>
                        <i class="fas fa-clock text-gray-500"></i>
                    </div>
                </div>

                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 text-center">
                    <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                    <span class="text-sm text-blue-300">Scan the same finger 3 times for accuracy</span>
                </div>

                <button onclick="cancelEnroll()" class="mt-6 w-full bg-dark-accent hover:bg-dark-accent/80 py-3 rounded-lg transition">
                    <i class="fas fa-times mr-2"></i>Cancel Enrollment
                </button>
            </div>

            <!-- Step 3: Success -->
            <div id="step3" class="hidden text-center">
                <div class="mb-6">
                    <div class="inline-block bg-green-500/20 p-6 rounded-full mb-4 animate-bounce">
                        <i class="fas fa-check-circle text-6xl text-green-500"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-green-500 mb-2">Enrollment Complete!</h3>
                    <p class="text-gray-400">Your fingerprint has been registered successfully</p>
                </div>
                
                <div class="bg-dark-accent rounded-xl p-6 mb-6 space-y-3">
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">User ID:</span>
                        <span class="font-bold text-blue-400 font-mono" id="successUserId">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">Name:</span>
                        <span class="font-bold" id="successUserName">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-400">Templates:</span>
                        <span class="text-green-500 font-semibold">
                            <i class="fas fa-check-circle mr-1"></i>3 / 3 Saved
                        </span>
                    </div>
                </div>

                <button onclick="registerAnother()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-plus mr-2"></i>Register Another User
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 right-6 bg-dark-secondary border border-dark-accent rounded-lg shadow-xl p-4 transform translate-y-32 transition-transform duration-300 max-w-sm z-50">
        <div class="flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-info-circle text-2xl"></i>
            <p id="toastMessage" class="text-sm"></p>
        </div>
    </div>

    <script>
        let currentUserId = '';
        let currentUserName = '';
        let checkInterval = null;
        let templateCount = 0;

        document.getElementById('nameForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            currentUserName = document.getElementById('userName').value.trim();
            const errorMsg = document.getElementById('errorMessage');

            try {
                const response = await fetch('/api/start_enroll', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: currentUserName })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUserId = data.user_id;
                    document.getElementById('assignedUserId').textContent = currentUserId;
                    goToStep(2);
                    startChecking();
                    showToast(`Enrollment started for ${currentUserName}`, 'info');
                    errorMsg.classList.add('hidden');
                } else {
                    errorMsg.textContent = data.message;
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Error: ' + error.message;
                errorMsg.classList.remove('hidden');
            }
        });

        function startChecking() {
            checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check_enroll_status/${currentUserId}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        const newCount = data.templates_count;
                        
                        if (newCount > templateCount) {
                            // Update progress
                            templateCount = newCount;
                            updateProgress(templateCount);
                            
                            if (data.completed) {
                                clearInterval(checkInterval);
                                setTimeout(() => showSuccess(), 500);
                            } else {
                                showToast(`Template ${templateCount}/3 received!`, 'success');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 1000);
        }

        function updateProgress(count) {
            const percentage = (count / 3) * 100;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('currentCount').textContent = count;
            
            // Update template status
            for (let i = 1; i <= count; i++) {
                const template = document.getElementById(`template${i}`);
                template.classList.remove('opacity-50');
                template.classList.add('bg-green-500/20');
                template.querySelector('i:last-child').className = 'fas fa-check-circle text-green-500 text-xl';
                template.querySelector('.fa-fingerprint').className = 'fas fa-fingerprint text-2xl text-green-500';
            }
        }

        function goToStep(stepNumber) {
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
        }

        function showSuccess() {
            goToStep(3);
            document.getElementById('successUserId').textContent = currentUserId;
            document.getElementById('successUserName').textContent = currentUserName;
            showToast('Enrollment completed!', 'success');
        }

        function cancelEnroll() {
            if (checkInterval) clearInterval(checkInterval);
            fetch(`/api/delete_user/${currentUserId}`, { method: 'DELETE' })
                .catch(err => console.error(err));
            registerAnother();
        }

        function registerAnother() {
            goToStep(1);
            document.getElementById('nameForm').reset();
            document.getElementById('errorMessage').classList.add('hidden');
            currentUserId = '';
            currentUserName = '';
            templateCount = 0;
            
            // Reset template status
            for (let i = 1; i <= 3; i++) {
                const template = document.getElementById(`template${i}`);
                template.classList.add('opacity-50');
                template.classList.remove('bg-green-500/20');
                template.querySelector('i:last-child').className = 'fas fa-clock text-gray-500';
                template.querySelector('.fa-fingerprint').className = 'fas fa-fingerprint text-2xl text-gray-500';
            }
            document.getElementById('progressBar').style.width = '0%';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            const configs = {
                success: { icon: 'fa-check-circle', color: 'text-green-500' },
                error: { icon: 'fa-exclamation-circle', color: 'text-red-500' },
                info: { icon: 'fa-info-circle', color: 'text-blue-500' }
            };
            
            const config = configs[type] || configs.info;
            icon.className = `fas ${config.icon} text-2xl ${config.color}`;
            messageEl.textContent = message;
            
            toast.style.transform = 'translateY(0)';
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
            }, 3000);
        }

        window.addEventListener('beforeunload', () => {
            if (checkInterval) clearInterval(checkInterval);
        });
    </script>
</body>
</html>