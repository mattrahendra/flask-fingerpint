<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fingerprint Registration System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            primary: '#0a0e27',
                            secondary: '#151b3d',
                            accent: '#1e2749',
                            blue: '#2563eb'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-primary text-gray-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-dark-secondary border-b border-dark-accent">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-fingerprint text-3xl text-blue-500"></i>
                    <div>
                        <h1 class="text-xl font-bold">Fingerprint System</h1>
                        <p class="text-xs text-gray-400">Registration Portal</p>
                    </div>
                </div>
                <a href="/dashboard" class="flex items-center space-x-2 bg-dark-accent hover:bg-dark-accent/80 px-4 py-2 rounded-lg transition font-semibold">
                    <i class="fas fa-chart-bar"></i>
                    <span>Dashboard</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Registration Page -->
    <div class="container mx-auto px-6 py-12 max-w-2xl">
        <div class="bg-dark-secondary rounded-2xl shadow-2xl p-8 border border-dark-accent">
            <div class="text-center mb-8">
                <div class="inline-block bg-blue-500/20 p-6 rounded-full mb-4">
                    <i class="fas fa-fingerprint text-5xl text-blue-500"></i>
                </div>
                <h2 class="text-3xl font-bold mb-2">Fingerprint Registration</h2>
                <p class="text-gray-400">Register your fingerprint to the system</p>
            </div>

            <!-- Step Indicator -->
            <div class="flex justify-between mb-8 relative">
                <div class="absolute top-5 left-0 right-0 h-0.5 bg-dark-accent"></div>
                <div class="step-indicator flex-1 text-center relative z-10">
                    <div class="step-circle active" id="stepCircle1">
                        <i class="fas fa-user"></i>
                    </div>
                    <p class="text-xs mt-2 font-semibold" id="stepLabel1">User Info</p>
                </div>
                <div class="step-indicator flex-1 text-center relative z-10">
                    <div class="step-circle" id="stepCircle2">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <p class="text-xs mt-2" id="stepLabel2">Scan Finger</p>
                </div>
                <div class="step-indicator flex-1 text-center relative z-10">
                    <div class="step-circle" id="stepCircle3">
                        <i class="fas fa-check"></i>
                    </div>
                    <p class="text-xs mt-2" id="stepLabel3">Complete</p>
                </div>
            </div>

            <!-- Step 1: Form -->
            <div id="step1" class="step-content">
                <form id="dataForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            <i class="fas fa-id-card mr-2 text-blue-500"></i>User ID
                        </label>
                        <input type="text" id="userId" 
                               class="w-full px-4 py-3 bg-dark-accent border border-dark-accent rounded-lg focus:border-blue-500 focus:outline-none transition text-gray-100"
                               placeholder="e.g., 001, 002, 003..." required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold mb-2">
                            <i class="fas fa-user mr-2 text-blue-500"></i>Full Name
                        </label>
                        <input type="text" id="userName" 
                               class="w-full px-4 py-3 bg-dark-accent border border-dark-accent rounded-lg focus:border-blue-500 focus:outline-none transition text-gray-100"
                               placeholder="Enter full name" required>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition flex items-center justify-center space-x-2">
                        <span>Continue to Scan</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </form>
                <div id="errorMessage" class="mt-4 hidden bg-red-500/20 border border-red-500 text-red-400 px-4 py-3 rounded-lg"></div>
            </div>

            <!-- Step 2: Waiting -->
            <div id="step2" class="step-content hidden text-center">
                <div class="bg-dark-accent border-2 border-dashed border-blue-500 rounded-xl p-8">
                    <div class="animate-pulse mb-6">
                        <i class="fas fa-fingerprint text-7xl text-blue-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2">Waiting for ESP32...</h3>
                    <p class="text-gray-400 mb-6">Please scan your fingerprint on the ESP32 device</p>
                    
                    <div class="bg-dark-secondary p-4 rounded-lg mb-6">
                        <p class="text-xs text-gray-400 mb-2">ESP32 Command:</p>
                        <code class="text-green-400 font-mono text-lg" id="espCommand">ENROLL:---</code>
                    </div>
                    
                    <div class="flex justify-center mb-4">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-dark-accent border-t-blue-500"></div>
                    </div>
                    
                    <p class="text-sm text-gray-500">
                        <i class="fas fa-info-circle mr-1"></i>
                        Make sure ESP32 is connected and ready
                    </p>
                </div>
                
                <button onclick="cancelEnroll()" class="mt-6 w-full bg-dark-accent hover:bg-dark-accent/80 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-arrow-left mr-2"></i>Cancel
                </button>
            </div>

            <!-- Step 3: Success -->
            <div id="step3" class="step-content hidden text-center">
                <div class="mb-6">
                    <div class="inline-block bg-green-500/20 p-6 rounded-full mb-4 animate-bounce">
                        <i class="fas fa-check-circle text-6xl text-green-500"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-green-500 mb-2">Registration Successful!</h3>
                    <p class="text-gray-400">Fingerprint has been saved to the system</p>
                </div>
                
                <div class="bg-dark-accent rounded-xl p-6 mb-6 text-left space-y-3">
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">User ID:</span>
                        <span class="font-bold text-blue-400" id="successUserId">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">Name:</span>
                        <span class="font-bold" id="successUserName">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">Registered:</span>
                        <span class="text-sm" id="successRegistered">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2 border-b border-dark-secondary">
                        <span class="text-gray-400">Enrolled:</span>
                        <span class="text-sm" id="successEnrolled">-</span>
                    </div>
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-400">Status:</span>
                        <span class="text-green-500 font-semibold">
                            <i class="fas fa-check-circle mr-1"></i>Enrolled
                        </span>
                    </div>
                </div>

                <button onclick="registerAnother()" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-plus mr-2"></i>Register Another User
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 right-6 bg-dark-secondary border border-dark-accent rounded-lg shadow-xl p-4 transform translate-y-32 transition-transform duration-300 max-w-sm z-50">
        <div class="flex items-center space-x-3">
            <i id="toastIcon" class="fas fa-info-circle text-2xl"></i>
            <p id="toastMessage" class="text-sm"></p>
        </div>
    </div>

    <style>
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1e2749;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 16px;
            transition: all 0.3s;
        }
        .step-circle.active {
            background: #2563eb;
            color: white;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
        }
        .step-circle.completed {
            background: #10b981;
            color: white;
        }
    </style>

    <script>
        let currentUserId = '';
        let currentUserName = '';
        let registeredTime = null;
        let checkInterval = null;

        // Registration Form
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            currentUserId = document.getElementById('userId').value.trim();
            currentUserName = document.getElementById('userName').value.trim();
            registeredTime = new Date();
            const errorMsg = document.getElementById('errorMessage');

            try {
                const response = await fetch('/api/register_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        name: currentUserName
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    goToStep(2);
                    document.getElementById('espCommand').textContent = `ENROLL:${currentUserId}`;
                    startChecking();
                    errorMsg.classList.add('hidden');
                } else {
                    errorMsg.textContent = data.message;
                    errorMsg.classList.remove('hidden');
                }
            } catch (error) {
                errorMsg.textContent = 'Error: ' + error.message;
                errorMsg.classList.remove('hidden');
            }
        });

        function startChecking() {
            checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/check_status/${currentUserId}`);
                    const data = await response.json();
                    
                    if (data.status === 'enrolled') {
                        clearInterval(checkInterval);
                        showSuccess();
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            }, 2000);
        }

        function goToStep(stepNumber) {
            // Update circles
            for (let i = 1; i <= 3; i++) {
                const circle = document.getElementById(`stepCircle${i}`);
                const label = document.getElementById(`stepLabel${i}`);
                circle.classList.remove('active', 'completed');
                label.classList.remove('font-semibold', 'text-blue-500');
                
                if (i < stepNumber) {
                    circle.classList.add('completed');
                } else if (i === stepNumber) {
                    circle.classList.add('active');
                    label.classList.add('font-semibold', 'text-blue-500');
                }
            }

            // Update content
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.add('hidden');
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
        }

        function showSuccess() {
            goToStep(3);
            document.getElementById('successUserId').textContent = currentUserId;
            document.getElementById('successUserName').textContent = currentUserName;
            document.getElementById('successRegistered').textContent = formatDateTime(registeredTime);
            document.getElementById('successEnrolled').textContent = formatDateTime(new Date());
        }

        function formatDateTime(date) {
            return date.toLocaleString('id-ID', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function cancelEnroll() {
            if (checkInterval) clearInterval(checkInterval);
            goToStep(1);
            fetch(`/api/delete_user/${currentUserId}`, { method: 'DELETE' })
                .catch(err => console.error(err));
        }

        function registerAnother() {
            goToStep(1);
            document.getElementById('dataForm').reset();
            document.getElementById('errorMessage').classList.add('hidden');
            currentUserId = '';
            currentUserName = '';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');
            
            const configs = {
                success: { icon: 'fa-check-circle', color: 'text-green-500' },
                error: { icon: 'fa-exclamation-circle', color: 'text-red-500' },
                info: { icon: 'fa-info-circle', color: 'text-blue-500' },
                warning: { icon: 'fa-exclamation-triangle', color: 'text-yellow-500' }
            };
            
            const config = configs[type] || configs.info;
            icon.className = `fas ${config.icon} text-2xl ${config.color}`;
            messageEl.textContent = message;
            
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(8rem)';
            }, 3000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (checkInterval) clearInterval(checkInterval);
        });
    </script>
</body>
</html>